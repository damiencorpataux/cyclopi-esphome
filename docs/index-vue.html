<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>CycloPi BLE</title>

    <!-- PWA meta -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#111111" />
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš²</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš²</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="card">
        <h1>ðŸš² CycloPi Backlight</h1>
        <div class="row">
            <button class="primary" @click="connect" :disabled="connected">Connect</button>
            <button class="muted" @click="disconnect" :disabled="!connected">Disconnect</button>
        </div>

        <div class="row">
            <button class="danger" @click="writeLightMode(0)" :disabled="!connected">OFF</button>
            <button class="ok" @click="writeLightMode(1)" :disabled="!connected">ON Backlight</button>
            <button class="ok" @click="writeLightMode(2)" :disabled="!connected">ON Headlight</button>
        </div>

        <div class="row">
            <label style="flex:1">Brightness: <span>{{ brightness }}</span></label>
            <input type="range" min="0" max="255" v-model.number="brightness" :disabled="!connected" @input="debouncedWriteBrightness" />
        </div>

        <div class="row">
            <label style="flex:1">Color:</label>
            <input type="color" v-model="color" :disabled="!connected" @input="debouncedWriteColor" />
        </div>

        <hr>

        <div class="row small">
            <label style="flex:1">Temperature:</label>
            <span class="pill mono">{{ temp }}</span>
        </div>
        <div class="row small">
            <label style="flex:1">Accel (m/sÂ²):</label>
            <span class="pill mono">{{ accel }}</span>
        </div>
        <div class="row small">
            <label style="flex:1">Gyro (Â°/s):</label>
            <span class="pill mono">{{ gyro }}</span>
        </div>

        <hr>

        <p class="small">
            Status: <span class="pill mono">{{ status }}</span>
        </p>
    </div>

    <!-- Vue CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                connected: false,
                status: "idle",
                brightness: 128,
                color: "#808080",
                accel: "â€”",
                gyro: "â€”",
                temp: "â€”",
                ble: {
                    device: null,
                    server: null,
                    service: null,
                    characteristic: {},
                    uuid: {
                        service:    "12345678-1234-5678-1234-56789abcdef0",
                        light_mode: "abcdef01-1234-5678-1234-56789abcdef0",
                        brightness: "abcdef02-1234-5678-1234-56789abcdef0",
                        color:      "abcdef03-1234-5678-1234-56789abcdef0",
                        accel:      "abcdef10-1234-5678-1234-56789abcdef0",
                        gyro:       "abcdef11-1234-5678-1234-56789abcdef0",
                        temp:       "abcdef12-1234-5678-1234-56789abcdef0"
                    }
                },
                writeTimeout: null
            }
        },
        mounted() {
            this.notifyUnsupported();
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js').catch(console.error);
                });
            }
        },
        methods: {
            setStatus(msg) { this.status = msg; },
            notifyUnsupported() {
                if (!('bluetooth' in navigator)) {
                    this.setStatus("Web Bluetooth not supported");
                    alert("This browser doesn't support Web Bluetooth.\n\nAndroid: use Chrome.\niPhone/iOS: see notes in README.");
                }
            },
            async connect() {
                try {
                    this.setStatus("requesting deviceâ€¦");
                    this.ble.device = await navigator.bluetooth.requestDevice({
                        filters: [{ namePrefix: "cyclopi" }],
                        optionalServices: [this.ble.uuid.service]
                    });
                    this.ble.device.addEventListener('gattserverdisconnected', this.onDisconnected);
                    this.setStatus("connectingâ€¦");
                    this.ble.server = await this.ble.device.gatt.connect();
                    this.ble.service = await this.ble.server.getPrimaryService(this.ble.uuid.service);

                    for (let key in this.ble.uuid) {
                        if (key !== 'service') {
                            this.ble.characteristic[key] = await this.ble.service.getCharacteristic(this.ble.uuid[key]);
                        }
                    }

                    this.connected = true;
                    this.setStatus("connected");

                    this.subscribeBrightness();
                    this.subscribeColor();
                    this.subscribeDisplay(this.ble.characteristic.accel, val => this.accel = val);
                    this.subscribeDisplay(this.ble.characteristic.gyro, val => this.gyro = val);
                    this.subscribeDisplay(this.ble.characteristic.temp, val => this.temp = val, 1);

                } catch (err) {
                    this.setStatus(err.message);
                    console.error(err);
                }
            },
            disconnect() {
                if (this.ble.device?.gatt?.connected) this.ble.device.gatt.disconnect();
                this.connected = false;
                this.setStatus("disconnected");
            },
            onDisconnected() {
                this.connected = false;
                this.setStatus("disconnected");
            },
            subscribeBrightness() {
                this.ble.characteristic.brightness.startNotifications().then(() => {
                    this.ble.characteristic.brightness.addEventListener("characteristicvaluechanged", e => {
                        this.brightness = e.target.value.getUint8(0);
                    });
                });
            },
            subscribeColor() {
                this.ble.characteristic.color.startNotifications().then(() => {
                    this.ble.characteristic.color.addEventListener("characteristicvaluechanged", e => {
                        const dv = e.target.value;
                        const hex = "#" + [...Array(3)].map((_,i) => dv.getUint8(i).toString(16).padStart(2,"0")).join("");
                        this.color = hex;
                    });
                });
            },
            subscribeDisplay(charHandle, cb, count = 3) {
                charHandle.startNotifications().then(() => {
                    charHandle.addEventListener("characteristicvaluechanged", e => {
                        const dv = e.target.value;
                        if (count === 1) {
                            cb(dv.getFloat32(0, true).toFixed(2));
                        } else {
                            const vals = [];
                            for (let i = 0; i < count; i++) {
                                vals.push(dv.getFloat32(i * 4, true).toFixed(2));
                            }
                            cb(vals.join(", "));
                        }
                    });
                });
            },
            async writeLightMode(v) {
                await this.ble.characteristic.light_mode.writeValue(Uint8Array.of(v & 0xff));
                this.setStatus(`set mode ${v}`);
            },
            async writeBrightnessNow(v) {
                await this.ble.characteristic.brightness.writeValue(Uint8Array.of(v & 0xff));
                this.setStatus(`set brightness ${v}`);
            },
            async writeColorNow(hex) {
                const r = parseInt(hex.slice(1,3),16);
                const g = parseInt(hex.slice(3,5),16);
                const b = parseInt(hex.slice(5,7),16);
                await this.ble.characteristic.color.writeValue(Uint8Array.of(r, g, b));
                this.setStatus(`set color to rgb(${r},${g},${b})`);
            },
            debouncedWriteBrightness() {
                clearTimeout(this.writeTimeout);
                this.writeTimeout = setTimeout(() => {
                    this.writeBrightnessNow(this.brightness).catch(console.error);
                }, 50);
            },
            debouncedWriteColor() {
                clearTimeout(this.writeTimeout);
                this.writeTimeout = setTimeout(() => {
                    this.writeColorNow(this.color).catch(console.error);
                }, 50);
            }
        }
    }).mount('#app');
    </script>
</body>
</html>
