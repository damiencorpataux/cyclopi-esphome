<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>CycloPi BLE</title>

    <!-- PWA meta -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#111111" />
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš²</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš²</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="card">
        <h1>ðŸš² CycloPi Backlight</h1>
        <div class="row">
            <button id="connect" class="primary">Connect</button>
            <button id="disconnect" class="muted" disabled>Disconnect</button>
        </div>

        <!-- Light Mode Buttons -->
        <div class="row">
            <button id="off" class="danger" disabled>OFF</button>
            <button id="on"  class="ok" disabled>ON Backlight</button>
            <button id="solid"  class="ok" disabled>ON Headlight</button>
        </div>

        <!-- Brightness Slider -->
        <div class="row">
            <label for="brightness" style="flex:1">Brightness: <span id="brightness-value">128</span></label>
            <input type="range" id="brightness" min="0" max="255" value="128" disabled>
        </div>

        <!-- Color Picker -->
        <div class="row">
            <label for="color" style="flex:1">Color:</label>
            <input type="color" id="color" disabled>
        </div>

        <hr>

        <!-- Sensor Values (QMI8658) -->
        <div class="row small">
            <label style="flex:1">Temperature:</label>
            <span id="temp-val" class="pill mono">â€”</span>
        </div>
        <div class="row small">
            <label style="flex:1">Accel (m/sÂ²):</label>
            <span id="accel-val" class="pill mono">â€”</span>
        </div>
        <div class="row small">
            <label style="flex:1">Gyro (Â°/s):</label>
            <span id="gyro-val" class="pill mono">â€”</span>
        </div>

        <hr>

        <!-- Status Line -->
        <p class="small">
            Status: <span id="status" class="pill mono">idle</span><br/>
        </p>
    </div>
    <a style="text-decoration:none; color:gray; display:block; text-align:center; font-size:66%" href="https://github.com/damiencorpataux/cyclopi-esphome">
        <svg height="32" aria-hidden="true" viewBox="0 0 24 24" version="1.1" width="32" data-view-component="true" class="github">
            <path fill="gray" d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"></path>
        </svg>
        <div>
            fork me on github
        </div>
    </a>
    <script>

        // UI helpers
        const $ = sel => document.querySelector(sel);
        const setStatus = s => $("#status").textContent = s;

        const btn = {
            connect:          $("#connect"),
            disconnect:       $("#disconnect"),
            on:               $("#on"),
            off:              $("#off"),
            solid:            $("#solid"),
            brightness:       $("#brightness"),
            brightness_value: $("#brightness-value"),
            color:            $("#color")
        };

        function enableControls(connected) {
            btn.connect.disabled    = connected;
            btn.disconnect.disabled = !connected;
            btn.off.disabled        = !connected || ble.value.light_mode == 0;
            btn.on.disabled         = !connected || ble.value.light_mode == 1;
            btn.solid.disabled      = !connected || ble.value.light_mode == 2;
            btn.brightness.disabled = !connected;
            btn.color.disabled = !connected;
        }

        function notifyUnsupported() {
            if (!('bluetooth' in navigator)) {
                setStatus("Web Bluetooth not supported");
                alert("This browser doesn't support Web Bluetooth.\n\nAndroid: use Chrome.\niPhone/iOS: see notes in README.");
            }
        }

        notifyUnsupported();

        // Core BLE logic
        const NAME_HINT = "cyclopi";
        const ble = {
            device: null,
            server: null,
            service: null,
            characteristic: {},
            value: {
                light_mode: null
            },
            uuid: {
                service:    "12345678-1234-5678-1234-56789abcdef0", // Service UUID
                light_mode: "abcdef01-1234-5678-1234-56789abcdef0", // light mode (off, backlight, headlight)
                brightness: "abcdef02-1234-5678-1234-56789abcdef0", // brightness
                color:      "abcdef03-1234-5678-1234-56789abcdef0", // new BLE characteristic for RGB
                accel:      "abcdef10-1234-5678-1234-56789abcdef0", // accel 3x float32
                gyro:       "abcdef11-1234-5678-1234-56789abcdef0", // gyro 3x float32
                temp:       "abcdef12-1234-5678-1234-56789abcdef0"  // temperature float32
            }
        };

        async function connect() {
            setStatus("requesting deviceâ€¦");
            const filters = [];
            if (NAME_HINT) filters.push({ namePrefix: NAME_HINT });

            ble.device = await navigator.bluetooth.requestDevice({
                filters: filters.length ? filters : undefined,
                optionalServices: [ble.uuid.service],
                acceptAllDevices: filters.length ? false : true
            });

            ble.device.addEventListener('gattserverdisconnected', onDisconnected);

            setStatus("connectingâ€¦");
            ble.server = await ble.device.gatt.connect();
            ble.service = await ble.server.getPrimaryService(ble.uuid.service);
            ble.characteristic.light_mode = await ble.service.getCharacteristic(ble.uuid.light_mode);
            ble.characteristic.brightness = await ble.service.getCharacteristic(ble.uuid.brightness);
            ble.characteristic.color = await ble.service.getCharacteristic(ble.uuid.color);
            ble.characteristic.accel = await ble.service.getCharacteristic(ble.uuid.accel);
            ble.characteristic.gyro  = await ble.service.getCharacteristic(ble.uuid.gyro);
            ble.characteristic.temp  = await ble.service.getCharacteristic(ble.uuid.temp);

            enableControls(true);
            setStatus("connected");

            // Subscribe to light mode
            ble.characteristic.light_mode.startNotifications().then(() => {
                ble.characteristic.light_mode.addEventListener("characteristicvaluechanged", e => {
                    const dv = e.target.value;
                    ble.value.light_mode = dv.getUint8(0);
                    enableControls(true);
                });
            });

            // Subscribe to brightness
            ble.characteristic.brightness.startNotifications().then(() => {
                ble.characteristic.brightness.addEventListener("characteristicvaluechanged", e => {
                    const dv = e.target.value;
                    const val_brightness = dv.getUint8(0);
                    btn.brightness.value = val_brightness;
                    btn.brightness_value.textContent = val_brightness;
                });
            });

            // Subscribe to color
            ble.characteristic.color.startNotifications().then(() => {
                ble.characteristic.color.addEventListener("characteristicvaluechanged", e => {
                    const dv = e.target.value;
                    const r = dv.getUint8(0);
                    const g = dv.getUint8(1);
                    const b = dv.getUint8(2);
                    // Convert to hex string #RRGGBB
                    const hex = "#" + r.toString(16).padStart(2, "0")
                                + g.toString(16).padStart(2, "0")
                                + b.toString(16).padStart(2, "0");
                    btn.color.value = hex;  // Initialize color picker
                });
            });

            // Subscribe and display sensor values (accel, gyro & temp)
            subscribeDisplay(ble.characteristic.accel, "#accel-val", 3);
            subscribeDisplay(ble.characteristic.gyro, "#gyro-val", 3);
            subscribeDisplay(ble.characteristic.temp, "#temp-val", 1);
        }

        async function disconnect() {
            if (ble.device?.gatt?.connected) ble.device.gatt.disconnect();
            enableControls(false);
            setStatus("disconnected");
        }

        function onDisconnected() {
            enableControls(false);
            setStatus("disconnected");
        }

        // Subscribe and display bluetooth characteristic value
        function subscribeDisplay(charHandle, selector, count = 1) {
            charHandle.startNotifications().then(() => {
                charHandle.addEventListener("characteristicvaluechanged", e => {
                    const dv = e.target.value;
                    if (count === 1) {
                        const val = dv.getFloat32(0, true);
                        document.querySelector(selector).textContent = val.toFixed(2);
                    } else {
                        const vals = [];
                        for (let i = 0; i < count; i++) {
                            vals.push(dv.getFloat32(i * 4, true).toFixed(2));
                        }
                        document.querySelector(selector).textContent = vals.join(" ");
                    }
                });
            });
        }

        async function writeLightMode(v) {
            if (!ble.characteristic.light_mode) throw new Error("Not connected");
            await ble.characteristic.light_mode.writeValue(Uint8Array.of(v & 0xff));
            setStatus(`set mode ${v}`);
        }

        async function writeBrightness(v) {
            if (!ble.characteristic.brightness) throw new Error("Not connected");
            await ble.characteristic.brightness.writeValue(Uint8Array.of(v & 0xff));
            btn.brightness_value.textContent = v;
            setStatus(`set brightness ${v}`);
        }

        async function writeColor(r, g, b) {
            if (!ble.characteristic.color) throw new Error("Not connected");
            await ble.characteristic.color.writeValue(Uint8Array.of(r, g, b));
            setStatus(`set color to rgb(${r},${g},${b})`);
        }

        // UI Wire Up
        btn.connect.addEventListener('click', () => connect().catch(err => { setStatus(err.message); console.error(err); }));
        btn.disconnect.addEventListener('click', () => disconnect().catch(console.error));
        btn.off.addEventListener('click', () => writeLightMode(0).catch(err => { setStatus(err.message); console.error(err); }));
        btn.on.addEventListener('click', () => writeLightMode(1).catch(err => { setStatus(err.message); console.error(err); }));
        btn.solid.addEventListener('click', () => writeLightMode(2).catch(err => { setStatus(err.message); console.error(err); }));
        let writeTimeout;
        btn.brightness.addEventListener('input', e => {
            const val = parseInt(e.target.value);
            clearTimeout(writeTimeout);
            writeTimeout = setTimeout(() => {
                writeBrightness(val).catch(console.error);
            }, 50); // wait n ms after last movement
        });
        btn.color.addEventListener('input', e => {
            const hex = e.target.value; // "#RRGGBB"
            const r = parseInt(hex.slice(1,3),16);
            const g = parseInt(hex.slice(3,5),16);
            const b = parseInt(hex.slice(5,7),16);
            clearTimeout(writeTimeout);
            writeTimeout = setTimeout(() => {
                writeColor(r, g, b).catch(console.error);
            }, 50); // wait n ms after last movement
        });

        // Progressive Web App service worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            });
        }
    </script>
</body>
</html>
