<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>CycloPi</title>

    <!-- PWA meta -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#111111" />
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚲</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚲</text></svg>">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="card">
        <h1>
            <span style="font-size:40px; margin-right:5px">🚲</span>
            CycloPi Omnilight
            <a style="float:right; color:#666; text-decoration:none; display:block; text-align:center" href="https://github.com/damiencorpataux/cyclopi-esphome">
                <svg height="24" aria-hidden="true" viewBox="0 0 24 24" version="1.1" width="32" data-view-component="true">
                    <path fill="#444" d="M12 1C5.923 1 1 5.923 1 12c0 4.867 3.149 8.979 7.521 10.436.55.096.756-.233.756-.522 0-.262-.013-1.128-.013-2.049-2.764.509-3.479-.674-3.699-1.292-.124-.317-.66-1.293-1.127-1.554-.385-.207-.936-.715-.014-.729.866-.014 1.485.797 1.691 1.128.99 1.663 2.571 1.196 3.204.907.096-.715.385-1.196.701-1.471-2.448-.275-5.005-1.224-5.005-5.432 0-1.196.426-2.186 1.128-2.956-.111-.275-.496-1.402.11-2.915 0 0 .921-.288 3.024 1.128a10.193 10.193 0 0 1 2.75-.371c.936 0 1.871.123 2.75.371 2.104-1.43 3.025-1.128 3.025-1.128.605 1.513.221 2.64.111 2.915.701.77 1.127 1.747 1.127 2.956 0 4.222-2.571 5.157-5.019 5.432.399.344.743 1.004.743 2.035 0 1.471-.014 2.654-.014 3.025 0 .289.206.632.756.522C19.851 20.979 23 16.854 23 12c0-6.077-4.922-11-11-11Z"></path>
                </svg>
                <div style="font-size:10px; font-weight:150;">
                    fork on<br>github
                </div>
            </a>
        </h1>

        <hr>

        <div class="row">
            <button id="connect" class="primary">Connect</button>
            <button id="disconnect" class="muted" disabled>Disconnect</button>
        </div>

        <!-- Light Mode Buttons -->
        <div class="row">
            <button id="off" class="danger" style="height:4em" disabled>OFF</button>
            <button id="on_back" class="ok" style="height:4em" disabled>ON Backlight</button>
            <button id="on_head" class="ok" style="height:4em" disabled>ON Headlight</button>
            <button id="on_effect" class="ok" style="height:4em" disabled>ON Effect</button>
        </div>

        <hr>

        <!-- Brightness Slider -->
        <div class="row">
            <label __for="brightness" style="flex:1">
                Brightness
                <span id="brightness-value" style="float:right"></span>
            </label>
            <input type="range" id="brightness" min="32" max="255" value="128" style="flex:1" disabled>
        </div>

        <!-- Color Picker -->
        <div class="row">
            <label __for="color" style="flex:1">Color</label>
            <input type="color" id="color" disabled>
        </div>

        <!-- Effect -->
        <div class="row">
            <label __for="effects" style="flex:1">Effect</label>
            <select id="effects" disabled></select>
        </div>

        <hr>

        <!-- Shake Detection Toggle -->
        <div class="row">
            <label __for="shake-toggle" style="flex:1" class="info">
                Shake Detection
            </label>
            <input type="checkbox" id="shake-toggle" disabled>
            <template>
                Shake detection lets you shake the device to change light mode.

                On every shake, the light mode cycles through OFF, ON Backlight, ON Headlights and ON Effect.

                You can disable the shake detection by unchecking the checkbox.
            </template>
        </div>

        <!-- Overheat Protection Toggle -->
        <div class="row">
            <label __for="overheat-toggle" style="flex:1" class="info">
                Overheat Protection
            </label>
            <input type="checkbox" id="overheat-toggle" disabled>
            <template>
                Overheat protection reduces the brightness of the light when the temperature is too high.

                This prevent the device from being damaged, especially when running in a hot or closed environment.

                It is not recommended to disable the overheat protection.
            </template>
        </div>

        <!-- Keep Controls Active Toggle -->
        <div class="row">
            <label __for="controls-toggle" style="flex:1" class="info">
                Keep Controls Active
            </label>
            <input type="checkbox" id="controls-toggle">
            <template>
                Controls like brightness, color and effect are disabled for light modes where they are not effective.

                Because you may want to update the value of controls even in a light mode when they are ineffective, you can keep the controls active all the time by checking the checkbox.
            </template>
        </div>

        <hr>

        <!-- Estimated Power -->
        <div class="row small">
            <label style="flex:1">
                Power estimation
                <span style="float:right; color:gray">W</span>
            </label>
            <span id="power" class="pill mono">—</span>
        </div>

        <!-- Sensor Values (QMI8658) -->
        <div class="row small">
            <label style="flex:1">
                Temperature
                <span style="float:right; color:gray">°C</span>
            </label>
            <span id="temp-val" class="pill mono">—</span>
        </div>
        <div class="row small">
            <label style="flex:1">
                Acceleration
                <span style="float:right; color:gray">m/s²</span>
            </label>
            <span id="accel-val" class="pill mono">—</span>
        </div>
        <div class="row small">
            <label style="flex:1">
                Gyroscope
                <span style="float:right; color:gray">°/s</span>
            </label>
            <span id="gyro-val" class="pill mono">—</span>
        </div>

        <!-- Status Line -->
        <div class="row small">
            <label>Status:</label>
            <span id="status"></span>
        </div>

        <hr>

        <div class="row">
            <button id="save_prefs" class="primary" disabled>💾&nbsp; Save Preferences</button>
        </div>
        <div style="font-size:.75rem; color:gray; text-align:center">
            Your device will start with the saved preferences.
        </div>
    </div>
    <footer style="font-size:10px; color:#444444; margin:-10px">
        © Damien Corpataux
    </footer>
    <script>

        /*
         * UI helpers
         */
        const $ = sel => document.querySelector(sel);
        const setStatus = s => $("#status").innerHTML = `<span class="pill mono">${s}</span>`;

        const btn = {
            connect:          $("#connect"),
            disconnect:       $("#disconnect"),
            save_prefs:       $("#save_prefs"),
            on_back:          $("#on_back"),
            off:              $("#off"),
            on_head:          $("#on_head"),
            on_effect:        $("#on_effect"),
            brightness:       $("#brightness"),
            brightness_value: $("#brightness-value"),
            color:            $("#color"),
            effects:          $("#effects"),
            shake_toggle:     $("#shake-toggle"),
            overheat_toggle:  $("#overheat-toggle"),
            controls_toggle:  $("#controls-toggle")
        };

        function enableControls() {
            const connected = ble.device?.gatt?.connected;
            btn.connect.disabled         = connected;
            btn.disconnect.disabled      = !connected;
            btn.save_prefs.disabled      = !connected;
            btn.off.disabled             = !connected || ble.value.light_mode == 0;
            btn.on_back.disabled         = !connected || ble.value.light_mode == 1;
            btn.on_head.disabled         = !connected || ble.value.light_mode == 2;
            btn.on_effect.disabled       = !connected || ble.value.light_mode == 3;
            btn.brightness.disabled      = !connected || (!btn.controls_toggle.checked && ![2,3].includes(ble.value.light_mode));
            btn.color.disabled           = !connected || (!btn.controls_toggle.checked && ![3].includes(ble.value.light_mode));
            btn.effects.disabled         = !connected || (!btn.controls_toggle.checked && ![3].includes(ble.value.light_mode));
            btn.shake_toggle.disabled    = !connected;
            btn.overheat_toggle.disabled = !connected;
            // Workaround for disabling <label> for <select> on Android Chrome
            document.querySelectorAll('.row').forEach(row => {
                const control = row.querySelector('input, select');
                const label = row.querySelector('label');
                if (control) {
                    label.style.color = control.disabled ? 'gray' : '';
                }
            });
        }

        /*
         * Core BLE logic
         */
        const ble = {
            name_hint: "cyclopi",  // For filtering devices in selector when pairing
            device: null,
            server: null,
            service: null,
            characteristic: {},
            value: {
                light_mode: null
            },
            uuid: {
                service:         "12345678-1234-5678-1234-56789abcdef0", // Service UUID
                save_prefs:      "abcdef00-1234-5678-1234-56789abcdef0", // save preferences
                light_mode:      "abcdef01-1234-5678-1234-56789abcdef0", // light mode
                brightness:      "abcdef02-1234-5678-1234-56789abcdef0", // brightness
                color:           "abcdef03-1234-5678-1234-56789abcdef0", // new BLE characteristic for RGB
                current_effect:  "abcdef06-1234-5678-1234-56789abcdef0", // current effect
                shake_toggle:    "abcdef04-1234-5678-1234-56789abcdef0", // shake detection toggle
                overheat_toggle: "abcdef05-1234-5678-1234-56789abcdef0", // overheat protection toggle
                power:           "abcdef20-1234-5678-1234-56789abcdef0", // power float32
                accel:           "abcdef10-1234-5678-1234-56789abcdef0", // accel 3x float32
                gyro:            "abcdef11-1234-5678-1234-56789abcdef0", // gyro 3x float32
                temp:            "abcdef12-1234-5678-1234-56789abcdef0"  // temperature float32
            }
        };

        async function connect() {
            if (!('bluetooth' in navigator)) {
                setStatus("Web Bluetooth not supported");
                alert("This browser doesn't support Web Bluetooth.\n\nAndroid: use Chrome.\niPhone/iOS: see notes in README.");
            }

            setStatus("requesting device…");
            const filters = [];
            if (ble?.name_hint) filters.push({ namePrefix: ble.name_hint });

            ble.device = await navigator.bluetooth.requestDevice({
                filters: filters.length ? filters : undefined,
                optionalServices: [ble.uuid.service],
                acceptAllDevices: filters.length ? false : true
            });

            ble.device.addEventListener('gattserverdisconnected', onDisconnected);

            setStatus("connecting…");
            ble.server = await ble.device.gatt.connect();
            ble.service = await ble.server.getPrimaryService(ble.uuid.service);
            ble.characteristic.save_prefs = await ble.service.getCharacteristic(ble.uuid.save_prefs);
            ble.characteristic.light_mode = await ble.service.getCharacteristic(ble.uuid.light_mode);
            ble.characteristic.brightness = await ble.service.getCharacteristic(ble.uuid.brightness);
            ble.characteristic.color = await ble.service.getCharacteristic(ble.uuid.color);
            ble.characteristic.current_effect = await ble.service.getCharacteristic(ble.uuid.current_effect);
            ble.characteristic.shake_toggle = await ble.service.getCharacteristic(ble.uuid.shake_toggle);
            ble.characteristic.overheat_toggle = await ble.service.getCharacteristic(ble.uuid.overheat_toggle);
            ble.characteristic.power = await ble.service.getCharacteristic(ble.uuid.power);
            ble.characteristic.accel = await ble.service.getCharacteristic(ble.uuid.accel);
            ble.characteristic.gyro  = await ble.service.getCharacteristic(ble.uuid.gyro);
            ble.characteristic.temp  = await ble.service.getCharacteristic(ble.uuid.temp);

            // Subscribe to save preferences
            await ble.characteristic.save_prefs.startNotifications();
            ble.characteristic.save_prefs.addEventListener("characteristicvaluechanged", e => {
                const dv = e.target.value;
                const success = dv.getUint8(0);
                window.requestAnimationFrame(() => {  // Race condition with setStatus() in writeSavePrefs()
                    if (success) {
                        setStatus('✅ preferences saved');
                    } else {
                        setStatus('❌ error saving preferences');
                    }
                });
            });

            // Subscribe to light mode
            await ble.characteristic.light_mode.startNotifications();
            ble.characteristic.light_mode.addEventListener("characteristicvaluechanged", e => {
                const dv = e.target.value;
                ble.value.light_mode = dv.getUint8(0);
                enableControls();
            });

            // Subscribe to brightness
            await ble.characteristic.brightness.startNotifications();
            ble.characteristic.brightness.addEventListener("characteristicvaluechanged", e => {
                const dv = e.target.value;
                const val_brightness = dv.getUint8(0);
                btn.brightness.value = val_brightness;
                btn.brightness_value.textContent = val_brightness;
            });

            // Subscribe to color
            await ble.characteristic.color.startNotifications();
            ble.characteristic.color.addEventListener("characteristicvaluechanged", e => {
                const dv = e.target.value;
                const r = dv.getUint8(0);
                const g = dv.getUint8(1);
                const b = dv.getUint8(2);
                // Convert to hex string #RRGGBB
                const hex = "#" + r.toString(16).padStart(2, "0")
                            + g.toString(16).padStart(2, "0")
                            + b.toString(16).padStart(2, "0");
                btn.color.value = hex;  // Initialize color picker
            });

            // Populate effects drop-down
            btn.effects.innerHTML = ""; // clear old options
            // Static effects options using ids
            const effects = [
                'Solid', 'Flicker', 'Rainbow', 'Fireworks', 'Pulse'
            ];
            effects.forEach((effect, i) => {
                const option = document.createElement("option");
                option.value = i; // or effect if you prefer
                option.textContent = effect;
                btn.effects.appendChild(option);
            });
            // Subscribe to current effect changes
            await ble.characteristic.current_effect.startNotifications();
            ble.characteristic.current_effect.addEventListener("characteristicvaluechanged", e => {
                const effectIndex = e.target.value.getUint8(0);  
                // Make sure the index is valid
                if (effectIndex >= 0 && effectIndex < btn.effects.options.length) {
                    btn.effects.selectedIndex = effectIndex;
                } else {
                    console.warn("Received invalid effect index:", effectIndex);
                }
            });

            // Subscribe to shake toggle
            await ble.characteristic.shake_toggle.startNotifications();
            ble.characteristic.shake_toggle.addEventListener("characteristicvaluechanged", e => {
                const dv = e.target.value;
                ble.value.shake_enabled = dv.getUint8(0) !== 0;
                btn.shake_toggle.checked = ble.value.shake_enabled;
            });

            // Subscribe to overheat protection
            await ble.characteristic.overheat_toggle.startNotifications();
            ble.characteristic.overheat_toggle.addEventListener("characteristicvaluechanged", e => {
                const dv = e.target.value;
                ble.value.overheat_toggle = dv.getUint8(0) !== 0;
                btn.overheat_toggle.checked = ble.value.overheat_toggle;
            });

            // Subscribe and display sensor values (accel, gyro & temp)
            await subscribeDisplay(ble.characteristic.power, "#power", 1, 1);
            await subscribeDisplay(ble.characteristic.temp, "#temp-val", 1, 1);
            await subscribeDisplay(ble.characteristic.accel, "#accel-val", 3, 2);
            await subscribeDisplay(ble.characteristic.gyro, "#gyro-val", 3, 2);

            enableControls();
            setStatus("connected");
        }

        async function disconnect() {
            if (ble.device?.gatt?.connected) ble.device.gatt.disconnect();
            enableControls();
            setStatus("disconnected");
        }

        function onDisconnected() {
            enableControls();
            setStatus("disconnected");
        }

        // Subscribe and display bluetooth characteristic value
        async function subscribeDisplay(charHandle, selector, count = 1, decimal = 2) {
            await charHandle.startNotifications();
            charHandle.addEventListener("characteristicvaluechanged", e => {
                const dv = e.target.value;
                if (count === 1) {
                    const val = dv.getFloat32(0, true);
                    document.querySelector(selector).textContent = val.toFixed(decimal);
                } else {
                    const vals = [];
                    for (let i = 0; i < count; i++) {
                        vals.push(dv.getFloat32(i * 4, true).toFixed(2));
                    }
                    document.querySelector(selector).textContent = vals.join(" ");
                }
            });
        }

        // Helper for writing BLE characteristics
        async function writeSavePrefs() {
            if (!ble.characteristic.save_prefs) throw new Error("Not connected");
            await ble.characteristic.save_prefs.writeValue(Uint8Array.of(1));
            setStatus("saving preferences…");
        }
        async function writeLightMode(v) {
            if (!ble.characteristic.light_mode) throw new Error("Not connected");
            await ble.characteristic.light_mode.writeValue(Uint8Array.of(v & 0xff));
            setStatus(`light mode ${v}`);
        }
        async function writeBrightness(v) {
            if (!ble.characteristic.brightness) throw new Error("Not connected");
            await ble.characteristic.brightness.writeValue(Uint8Array.of(v & 0xff));
            setStatus(`brightness to ${v}`);
        }
        async function writeColor(r, g, b) {
            if (!ble.characteristic.color) throw new Error("Not connected");
            await ble.characteristic.color.writeValue(Uint8Array.of(r, g, b));
            setStatus(`color to rgb(${r},${g},${b})`);
        }
        async function writeEffect(id) {
            if (!ble.characteristic.current_effect) throw new Error("Not connected");
            const bytes = new Uint8Array([id]);  // Convert integer to Uint8Array (1 byte)
            await ble.characteristic.current_effect.writeValue(bytes).catch(console.error);
            setStatus(`effect to ${id}`);
        }
        async function writeShake(enabled) {
            if (!ble.characteristic.shake_toggle) throw new Error("Not connected");
            await ble.characteristic.shake_toggle.writeValue(Uint8Array.of(enabled ? 1 : 0));
            setStatus(`shake detection ${enabled ? "enabled" : "disabled"}`);
        }
        async function writeOverheatProtection(enabled) {
            if (!ble.characteristic.overheat_toggle) throw new Error("Not connected");
            await ble.characteristic.overheat_toggle.writeValue(Uint8Array.of(enabled ? 1 : 0));
            setStatus(`overheat protection ${enabled ? "enabled" : "disabled"}`);
        }

        /*
         * UI Wire Up
         */
        setStatus('idle')
        enableControls();  // Initial controls state
        let writeTimeout;  // Used by timers to debounce writing to BLE
        btn.save_prefs.addEventListener('click', () => writeSavePrefs().catch(console.error));
        btn.connect.addEventListener('click', () => connect().catch(err => { setStatus(err.message); console.error(err); }));
        btn.disconnect.addEventListener('click', () => disconnect().catch(console.error));
        btn.off.addEventListener('click', () => writeLightMode(0).catch(err => { setStatus(err.message); console.error(err); }));
        btn.on_back.addEventListener('click', () => writeLightMode(1).catch(err => { setStatus(err.message); console.error(err); }));
        btn.on_head.addEventListener('click', () => writeLightMode(2).catch(err => { setStatus(err.message); console.error(err); }));
        btn.on_effect.addEventListener('click', () => writeLightMode(3).catch(err => { setStatus(err.message); console.error(err); }));
        btn.brightness.addEventListener('input', e => {
            const val = parseInt(e.target.value);
            clearTimeout(writeTimeout);
            writeTimeout = setTimeout(() => {
                writeBrightness(val).catch(console.error);
            }, 50); // wait n ms after last movement
        });
        btn.color.addEventListener('input', e => {
            const hex = e.target.value; // "#RRGGBB"
            const r = parseInt(hex.slice(1,3),16);
            const g = parseInt(hex.slice(3,5),16);
            const b = parseInt(hex.slice(5,7),16);
            clearTimeout(writeTimeout);
            writeTimeout = setTimeout(() => {
                writeColor(r, g, b).catch(console.error);
            }, 50); // wait n ms after last movement
        });
        btn.effects.addEventListener("change", e => {
            const effectId = parseInt(e.target.value, 10); // ensure it's an integer
            writeEffect(effectId);
        });
        btn.shake_toggle.addEventListener('change', e => {
            writeShake(e.target.checked).catch(console.error);
        });
        btn.overheat_toggle.addEventListener('click', e => {
            if (!e.target.checked) {
                if (!confirm("Overheating can damage your device !\n\nAre you sure to disable ?")) {
                    e.preventDefault();
                    return;
                }
            }
            writeOverheatProtection(e.target.checked).catch(console.error);
        });
        btn.controls_toggle.addEventListener('change', e => {
            localStorage.setItem("controls_toggle", e.target.checked);  // Save to localStorage
            enableControls();
        });
        const controls_toggle_saved = localStorage.getItem("controls_toggle"); // Restore toggle state on page load
        if (controls_toggle_saved !== null) {
            btn.controls_toggle.checked = controls_toggle_saved === "true";
            enableControls();
        }

        // Show info popup with text present in <template>
        for (const info of document.querySelectorAll(".info")) {
            info.addEventListener('click', e => {
                function dedent(str) {
                    const lines = str.replace(/^\n/, '').split('\n');  // Split into lines
                    const indent = Math.min(                           // Find the minimum indentation of non-empty lines
                        ...lines.filter(line => line.trim()).map(line => line.match(/^ */)[0].length)
                    );
                    return lines.map(line => line.slice(indent)).join('\n').trim(); // Remove that indent
                }
                const info_text = dedent(event.target.parentElement.querySelector('template').content.textContent);
                alert(`ⓘ  ${e.target.textContent.trim()}\n\n` + info_text);
            });
        }

        // Progressive Web App service worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            });
        }

        $("footer").textContent += new Date().getFullYear(); 
    </script>
</body>
</html>
