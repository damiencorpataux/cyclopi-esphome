<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CycloPi BLE</title>

  <!-- PWA meta -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111" />
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #0e0e10; color: #eaeaea; display: grid; min-height: 100vh; place-items: center; }
    .card { width: min(440px, 92vw); background: #151517; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 12px; font-size: 1.25rem; }
    .row { display: flex; gap: 10px; margin: 12px 0; flex-wrap: wrap; }
    button { flex: 1; padding: 12px 14px; border-radius: 12px; border: 0; font-weight: 600; background: #2a2a2e; color: #fff; }
    button:disabled { opacity: .6 }
    .primary { background: #3a74ff; }
    .danger  { background: #ff4567; }
    .ok      { background: #28c981; }
    .muted   { background: #2a2a2e; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .9rem; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #212125; display: inline-block; }
    .small { opacity: .8; font-size: .9rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸš² CycloPi Backlight</h1>
    <div class="row">
      <button id="connect" class="primary">Connect</button>
      <button id="disconnect" class="muted" disabled>Disconnect</button>
    </div>

    <div class="row">
      <button id="on"  class="ok" disabled>Turn ON</button>
      <button id="off" class="danger" disabled>Turn OFF</button>
    </div>

    <div class="row">
      <button id="read" class="muted" disabled>Read State</button>
      <button id="subscribe" class="muted" disabled>Subscribe</button>
    </div>

    <p class="small">
      Status: <span id="status" class="pill mono">idle</span><br/>
      Value: <span id="value" class="pill mono">â€”</span>
    </p>
  </div>

  <script>
    // ==== CONFIG: set your GATT UUIDs ====
    const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
    const CHAR_UUID    = "abcdef01-1234-5678-1234-56789abcdef0";
    const NAME_HINT    = "cyclopi"; // optional filter by name

    // ==== UI helpers ====
    const $ = sel => document.querySelector(sel);
    const setStatus = (s) => $("#status").textContent = s;
    const setValue  = (v) => $("#value").textContent  = v;

    const btn = {
      connect:    $("#connect"),
      disconnect: $("#disconnect"),
      on:         $("#on"),
      off:        $("#off"),
      read:       $("#read"),
      subscribe:  $("#subscribe"),
    };

    let device, server, service, characteristic;

    function enableControls(connected) {
      btn.connect.disabled    = connected;
      btn.disconnect.disabled = !connected;
      btn.on.disabled         = !connected;
      btn.off.disabled        = !connected;
      btn.read.disabled       = !connected;
      btn.subscribe.disabled  = !connected;
    }

    function notifyUnsupported() {
      if (!('bluetooth' in navigator)) {
        setStatus("Web Bluetooth not supported");
        alert("This browser doesn't support Web Bluetooth.\n\nAndroid: use Chrome.\niPhone/iOS: see notes in README (Web Bluetooth is not available in Safari/PWA).");
      }
    }

    notifyUnsupported();

    // ==== Core BLE logic ====
    async function connect() {
      setStatus("requesting deviceâ€¦");
      const filters = [];
      if (NAME_HINT) filters.push({ namePrefix: NAME_HINT });

      device = await navigator.bluetooth.requestDevice({
        filters: filters.length ? filters : undefined,
        optionalServices: [SERVICE_UUID],
        acceptAllDevices: filters.length ? false : true
      });

      device.addEventListener('gattserverdisconnected', onDisconnected);

      setStatus("connectingâ€¦");
      server = await device.gatt.connect();
      service = await server.getPrimaryService(SERVICE_UUID);
      characteristic = await service.getCharacteristic(CHAR_UUID);

      enableControls(true);
      setStatus("connected");
    }

    async function disconnect() {
      if (device?.gatt?.connected) device.gatt.disconnect();
      enableControls(false);
      setStatus("disconnected");
      setValue("â€”");
    }

    function onDisconnected() {
      enableControls(false);
      setStatus("disconnected");
    }

    async function writeValue(v) {
      if (!characteristic) throw new Error("Not connected");
      const data = new Uint8Array([v & 0xff]);
      await characteristic.writeValue(data);
      setStatus(`wrote ${v}`);
    }

    async function readValue() {
      if (!characteristic) throw new Error("Not connected");
      const dv = await characteristic.readValue();
      const val = dv.getUint8(0);
      setValue(val);
      setStatus(`read ${val}`);
      return val;
    }

    async function subscribe() {
      if (!characteristic) throw new Error("Not connected");
      await characteristic.startNotifications();
      characteristic.addEventListener('characteristicvaluechanged', (e) => {
        const v = e.target.value.getUint8(0);
        setValue(v);
        setStatus(`notified ${v}`);
      });
      btn.subscribe.disabled = true;
      setStatus("subscribed");
    }

    // ==== Wire up UI ====
    btn.connect.addEventListener('click', () => connect().catch(err => { setStatus(err.message); console.error(err); }));
    btn.disconnect.addEventListener('click', () => disconnect().catch(console.error));
    btn.on.addEventListener('click', () => writeValue(1).catch(err => { setStatus(err.message); console.error(err); }));
    btn.off.addEventListener('click', () => writeValue(0).catch(err => { setStatus(err.message); console.error(err); }));
    btn.read.addEventListener('click', () => readValue().catch(err => { setStatus(err.message); console.error(err); }));
    btn.subscribe.addEventListener('click', () => subscribe().catch(err => { setStatus(err.message); console.error(err); }));

    // ==== PWA service worker registration ====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
