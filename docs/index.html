<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CycloPi BLE</title>

  <!-- PWA meta -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111" />
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    body { margin: 0; background: #0e0e10; color: #eaeaea; display: grid; min-height: 100vh; place-items: center; }
    .card { width: min(440px, 92vw); background: #151517; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 12px; font-size: 1.25rem; }
    .row { display: flex; gap: 10px; margin: 12px 0; flex-wrap: wrap; align-items: center; }
    button { flex: 1; padding: 12px 14px; border-radius: 12px; border: 0; font-weight: 600; background: #2a2a2e; color: #fff; }
    button:disabled { opacity: .6 }
    .primary { background: #3a74ff; }
    .danger  { background: #ff4567; }
    .ok      { background: #28c981; }
    .muted   { background: #2a2a2e; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .9rem; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #212125; display: inline-block; }
    .small { opacity: .8; font-size: .9rem; }
    input[type="range"] { width: 100%; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ðŸš² CycloPi Backlight</h1>
    <div class="row">
      <button id="connect" class="primary">Connect</button>
      <button id="disconnect" class="muted" disabled>Disconnect</button>
    </div>

    <div class="row">
      <button id="off" class="danger" disabled>OFF</button>
      <button id="on"  class="ok" disabled>ON Backlight</button>
      <button id="solid"  class="ok" disabled>ON Headlight</button>
    </div>

    <div class="row">
      <button id="read" class="muted" disabled>Read State</button>
      <button id="subscribe" class="muted" disabled>Subscribe</button>
    </div>

    <!-- New Brightness Slider -->
    <div class="row">
      <label for="brightness" style="flex:1">Brightness: <span id="brightness-value">128</span></label>
      <input type="range" id="brightness" min="0" max="255" value="128" disabled>
    </div>

    <p class="small">
      Status: <span id="status" class="pill mono">idle</span><br/>
      Value: <span id="value" class="pill mono">â€”</span>
    </p>
  </div>

  <script>
    // ==== CONFIG: set your GATT UUIDs ====
    const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
    const CHAR_UUID    = "abcdef01-1234-5678-1234-56789abcdef0"; // on/off
    const BRIGHT_UUID  = "abcdef02-1234-5678-1234-56789abcdef0"; // brightness
    const NAME_HINT    = "cyclopi";

    // ==== UI helpers ====
    const $ = sel => document.querySelector(sel);
    const setStatus = s => $("#status").textContent = s;
    const setValue  = v => $("#value").textContent  = v;

    const btn = {
      connect:          $("#connect"),
      disconnect:       $("#disconnect"),
      on:               $("#on"),
      off:              $("#off"),
      solid:            $("#solid"),
      read:             $("#read"),
      subscribe:        $("#subscribe"),
      brightness:       $("#brightness"),
      brightness_value: $("#brightness-value")
    };

    function enableControls(connected) {
      btn.connect.disabled    = connected;
      btn.disconnect.disabled = !connected;
      btn.off.disabled        = !connected;
      btn.on.disabled         = !connected;
      btn.solid.disabled        = !connected;
      btn.read.disabled       = !connected;
      btn.subscribe.disabled  = !connected;
      btn.brightness.disabled     = !connected;
    }

    function notifyUnsupported() {
      if (!('bluetooth' in navigator)) {
        setStatus("Web Bluetooth not supported");
        alert("This browser doesn't support Web Bluetooth.\n\nAndroid: use Chrome.\niPhone/iOS: see notes in README.");
      }
    }

    notifyUnsupported();

    // ==== Core BLE logic ====

    const ble = {
        device: null,
        server: null,
        service: null,
        characteristic: {}
    };

    async function connect() {
      setStatus("requesting deviceâ€¦");
      const filters = [];
      if (NAME_HINT) filters.push({ namePrefix: NAME_HINT });

      ble.device = await navigator.bluetooth.requestDevice({
        filters: filters.length ? filters : undefined,
        optionalServices: [SERVICE_UUID],
        acceptAllDevices: filters.length ? false : true
      });

      ble.device.addEventListener('gattserverdisconnected', onDisconnected);

      setStatus("connectingâ€¦");
      ble.server = await ble.device.gatt.connect();
      ble.service = await ble.server.getPrimaryService(SERVICE_UUID);
      ble.characteristic.light_mode = await ble.service.getCharacteristic(CHAR_UUID);
      ble.characteristic.brightness = await ble.service.getCharacteristic(BRIGHT_UUID);

      enableControls(true);
      setStatus("connected");

      // Read initial brightness
      const val = await ble.characteristic.brightness.readValue();
      const b = val.getUint8(0);
      btn.brightness.value = b;
      btn.brightness_value.textContent = b;
    }

    async function disconnect() {
      if (ble.device?.gatt?.connected) ble.device.gatt.disconnect();
      enableControls(false);
      setStatus("disconnected");
      setValue("â€”");
    }

    function onDisconnected() {
      enableControls(false);
      setStatus("disconnected");
    }

    async function writeValue(v) {
      if (!ble.characteristic.light_mode) throw new Error("Not connected");
      await ble.characteristic.light_mode.writeValue(Uint8Array.of(v & 0xff));
      setStatus(`wrote ${v}`);
    }

    async function writeBrightness(v) {
      if (!ble.characteristic.brightness) throw new Error("Not connected");
      await ble.characteristic.brightness.writeValue(Uint8Array.of(v & 0xff));
      btn.brightness_value.textContent = v;
      setStatus(`brightness ${v}`);
    }

    async function readValue() {
      if (!ble.characteristic.light_mode) throw new Error("Not connected");
      const dv = await ble.characteristic.light_mode.readValue();
      const val = dv.getUint8(0);
      setValue(val);
      setStatus(`read ${val}`);
      return val;
    }

    async function subscribe() {
      if (!ble.characteristic.light_mode) throw new Error("Not connected");
      await ble.characteristic.light_mode.startNotifications();
      ble.characteristic.light_mode.addEventListener('characteristicvaluechanged', (e) => {
        const v = e.target.value.getUint8(0);
        setValue(v);
        setStatus(`notified ${v}`);
      });
      btn.subscribe.disabled = true;
      setStatus("subscribed");
    }

    // ==== Wire up UI ====
    btn.connect.addEventListener('click', () => connect().catch(err => { setStatus(err.message); console.error(err); }));
    btn.disconnect.addEventListener('click', () => disconnect().catch(console.error));
    btn.off.addEventListener('click', () => writeValue(0).catch(err => { setStatus(err.message); console.error(err); }));
    btn.on.addEventListener('click', () => writeValue(1).catch(err => { setStatus(err.message); console.error(err); }));
    btn.solid.addEventListener('click', () => writeValue(2).catch(err => { setStatus(err.message); console.error(err); }));
    btn.read.addEventListener('click', () => readValue().catch(err => { setStatus(err.message); console.error(err); }));
    btn.subscribe.addEventListener('click', () => subscribe().catch(err => { setStatus(err.message); console.error(err); }));

    btn.brightness.addEventListener('input', e => {
      const val = parseInt(e.target.value);
      writeBrightness(val).catch(console.error);
    });

    // ==== PWA service worker registration ====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
