<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>CycloPi BLE</title>

    <!-- PWA meta -->
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#111111" />
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš²</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸš²</text></svg>">

    <style>
        :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
        body { margin: 0; background: #0e0e10; color: #eaeaea; display: grid; min-height: 100vh; place-items: center; }
        .card { width: min(440px, 92vw); background: #151517; padding: 20px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
        h1 { margin: 0 0 12px; font-size: 1.25rem; }
        .row { display: flex; gap: 10px; margin: 12px 0; flex-wrap: wrap; align-items: center; }
        button { flex: 1; padding: 12px 14px; border-radius: 12px; border: 0; font-weight: 600; background: #2a2a2e; color: #fff; }
        button:disabled { opacity: .6 }
        .primary { background: #3a74ff; }
        .danger  { background: #ff4567; }
        .ok      { background: #28c981; }
        .muted   { background: #2a2a2e; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .9rem; }
        .pill { padding: 6px 10px; border-radius: 999px; background: #212125; display: inline-block; }
        .small { opacity: .8; font-size: .9rem; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ðŸš² CycloPi Backlight</h1>
        <div class="row">
            <button id="connect" class="primary">Connect</button>
            <button id="disconnect" class="muted" disabled>Disconnect</button>
        </div>

        <!-- Light Mode Buttons -->
        <div class="row">
            <button id="off" class="danger" disabled>OFF</button>
            <button id="on"  class="ok" disabled>ON Backlight</button>
            <button id="solid"  class="ok" disabled>ON Headlight</button>
        </div>

        <!-- Brightness Slider -->
        <div class="row">
            <label for="brightness" style="flex:1">Brightness: <span id="brightness-value">128</span></label>
            <input type="range" id="brightness" min="0" max="255" value="128" disabled>
        </div>

        <!-- Color Picker -->
        <div class="row">
            <label for="color" style="flex:1">Color:</label>
            <input type="color" id="color" disabled>
        </div>

        <hr>

        <!-- Sensor Values (QMI8658) -->
        <div class="row small">
            <label style="flex:1">Temperature:</label>
            <span id="temp-val" class="pill mono">â€”</span>
        </div>
        <div class="row small">
            <label style="flex:1">Accel (m/sÂ²):</label>
            <span id="accel-val" class="pill mono">â€”</span>
        </div>
        <div class="row small">
            <label style="flex:1">Gyro (Â°/s):</label>
            <span id="gyro-val" class="pill mono">â€”</span>
        </div>

        <hr>

        <!-- Status Line -->
        <p class="small">
            Status: <span id="status" class="pill mono">idle</span><br/>
        </p>
    </div>

    <script>

        // UI helpers
        const $ = sel => document.querySelector(sel);
        const setStatus = s => $("#status").textContent = s;

        const btn = {
            connect:          $("#connect"),
            disconnect:       $("#disconnect"),
            on:               $("#on"),
            off:              $("#off"),
            solid:            $("#solid"),
            brightness:       $("#brightness"),
            brightness_value: $("#brightness-value"),
            color:            $("#color")
        };

        function enableControls(connected) {
            btn.connect.disabled    = connected;
            btn.disconnect.disabled = !connected;
            btn.off.disabled        = !connected;
            btn.on.disabled         = !connected;
            btn.solid.disabled      = !connected;
            btn.brightness.disabled = !connected;
            btn.color.disabled = !connected;
        }

        function notifyUnsupported() {
            if (!('bluetooth' in navigator)) {
                setStatus("Web Bluetooth not supported");
                alert("This browser doesn't support Web Bluetooth.\n\nAndroid: use Chrome.\niPhone/iOS: see notes in README.");
            }
        }

        notifyUnsupported();

        // Core BLE logic
        const NAME_HINT = "cyclopi";
        const ble = {
            device: null,
            server: null,
            service: null,
            characteristic: {},
            uuid: {
                service:    "12345678-1234-5678-1234-56789abcdef0", // Service UUID
                light_mode: "abcdef01-1234-5678-1234-56789abcdef0", // light mode (off, backlight, headlight)
                brightness: "abcdef02-1234-5678-1234-56789abcdef0", // brightness
                color:      "abcdef03-1234-5678-1234-56789abcdef0", // new BLE characteristic for RGB
                accel:      "abcdef10-1234-5678-1234-56789abcdef0", // accel 3x float32
                gyro:       "abcdef11-1234-5678-1234-56789abcdef0", // gyro 3x float32
                temp:       "abcdef12-1234-5678-1234-56789abcdef0"  // temperature float32
            }
        };

        async function connect() {
            setStatus("requesting deviceâ€¦");
            const filters = [];
            if (NAME_HINT) filters.push({ namePrefix: NAME_HINT });

            ble.device = await navigator.bluetooth.requestDevice({
                filters: filters.length ? filters : undefined,
                optionalServices: [ble.uuid.service],
                acceptAllDevices: filters.length ? false : true
            });

            ble.device.addEventListener('gattserverdisconnected', onDisconnected);

            setStatus("connectingâ€¦");
            ble.server = await ble.device.gatt.connect();
            ble.service = await ble.server.getPrimaryService(ble.uuid.service);
            ble.characteristic.light_mode = await ble.service.getCharacteristic(ble.uuid.light_mode);
            ble.characteristic.brightness = await ble.service.getCharacteristic(ble.uuid.brightness);
            ble.characteristic.color = await ble.service.getCharacteristic(ble.uuid.color);
            ble.characteristic.accel = await ble.service.getCharacteristic(ble.uuid.accel);
            ble.characteristic.gyro  = await ble.service.getCharacteristic(ble.uuid.gyro);
            ble.characteristic.temp  = await ble.service.getCharacteristic(ble.uuid.temp);

            enableControls(true);
            setStatus("connected");

            // Subscribe to brightness
            ble.characteristic.brightness.startNotifications().then(() => {
                ble.characteristic.brightness.addEventListener("characteristicvaluechanged", e => {
                    const dv = e.target.value;
                    const val_brightness = dv.getUint8(0);
                    btn.brightness.value = val_brightness;
                    btn.brightness_value.textContent = val_brightness;
                });
            });

            // Subscribe to color
            ble.characteristic.color.startNotifications().then(() => {
                ble.characteristic.color.addEventListener("characteristicvaluechanged", e => {
                    const dv = e.target.value;
                    const r = dv.getUint8(0);
                    const g = dv.getUint8(1);
                    const b = dv.getUint8(2);
                    // Convert to hex string #RRGGBB
                    const hex = "#" + r.toString(16).padStart(2, "0")
                                + g.toString(16).padStart(2, "0")
                                + b.toString(16).padStart(2, "0");
                    btn.color.value = hex;  // Initialize color picker
                });
            });

            // Subscribe and display sensor values (accel, gyro & temp)
            subscribeDisplay(ble.characteristic.accel, "#accel-val", 3);
            subscribeDisplay(ble.characteristic.gyro, "#gyro-val", 3);
            subscribeDisplay(ble.characteristic.temp, "#temp-val", 1);
        }

        async function disconnect() {
            if (ble.device?.gatt?.connected) ble.device.gatt.disconnect();
            enableControls(false);
            setStatus("disconnected");
        }

        function onDisconnected() {
            enableControls(false);
            setStatus("disconnected");
        }

        // Subscribe and display bluetooth characteristic value
        function subscribeDisplay(charHandle, selector, count = 1) {
            charHandle.startNotifications().then(() => {
                charHandle.addEventListener("characteristicvaluechanged", e => {
                    const dv = e.target.value;
                    if (count === 1) {
                        const val = dv.getFloat32(0, true);
                        document.querySelector(selector).textContent = val.toFixed(2);
                    } else {
                        const vals = [];
                        for (let i = 0; i < count; i++) {
                            vals.push(dv.getFloat32(i * 4, true).toFixed(2));
                        }
                        document.querySelector(selector).textContent = vals.join(", ");
                    }
                });
            });
        }

        async function writeLightMode(v) {
            if (!ble.characteristic.light_mode) throw new Error("Not connected");
            await ble.characteristic.light_mode.writeValue(Uint8Array.of(v & 0xff));
            setStatus(`set mode ${v}`);
        }

        async function writeBrightness(v) {
            if (!ble.characteristic.brightness) throw new Error("Not connected");
            await ble.characteristic.brightness.writeValue(Uint8Array.of(v & 0xff));
            btn.brightness_value.textContent = v;
            setStatus(`set brightness ${v}`);
        }

        async function writeColor(r, g, b) {
            if (!ble.characteristic.color) throw new Error("Not connected");
            await ble.characteristic.color.writeValue(Uint8Array.of(r, g, b));
            setStatus(`set color to rgb(${r},${g},${b})`);
        }

        // UI Wire Up
        btn.connect.addEventListener('click', () => connect().catch(err => { setStatus(err.message); console.error(err); }));
        btn.disconnect.addEventListener('click', () => disconnect().catch(console.error));
        btn.off.addEventListener('click', () => writeLightMode(0).catch(err => { setStatus(err.message); console.error(err); }));
        btn.on.addEventListener('click', () => writeLightMode(1).catch(err => { setStatus(err.message); console.error(err); }));
        btn.solid.addEventListener('click', () => writeLightMode(2).catch(err => { setStatus(err.message); console.error(err); }));
        let writeTimeout;
        btn.brightness.addEventListener('input', e => {
            const val = parseInt(e.target.value);
            clearTimeout(writeTimeout);
            writeTimeout = setTimeout(() => {
                writeBrightness(val).catch(console.error);
            }, 50); // wait n ms after last movement
        });
        btn.color.addEventListener('input', e => {
            const hex = e.target.value; // "#RRGGBB"
            const r = parseInt(hex.slice(1,3),16);
            const g = parseInt(hex.slice(3,5),16);
            const b = parseInt(hex.slice(5,7),16);
            clearTimeout(writeTimeout);
            writeTimeout = setTimeout(() => {
                writeColor(r, g, b).catch(console.error);
            }, 50); // wait n ms after last movement
        });

        // Progressive Web App service worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(console.error);
            });
        }
    </script>
</body>
</html>
